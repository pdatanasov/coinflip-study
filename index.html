<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Coin Flip Casino</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 30px; }
        #history { margin-top: 20px; max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
        button { margin-right: 5px; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>Coin Flip Casino</h1>
    <p>Balance:             $<span id="balance">0.50</span></p>
    <!-- Display current bias (shown for both conditions) -->
    <p>Probability of Heads: <span id="biasDisplay">-</span></p>

    <p>Condition: <span id="conditionDisplay"></span></p>

    <!-- Treatment buttons -->
    <div id="treatmentButtons" style="display:none;">
        <button type="button" onclick="quickBet5()">Bet 5 cents</button>
        <button type="button" onclick="quickBetKelly()">Bet Kelly</button>
        <br><br>
    </div>

    <!-- Bet input -->
    <label>Bet Amount (in cents): </label>
    <input type="number" id="bet" step="1" min="1">
    <br><br>

    <!-- Heads/Tails buttons -->
    <button onclick="play('Heads')">Heads</button>
    <button onclick="play('Tails')">Tails</button>


    <!-- History -->
    <div id="history"></div>

    <script>
        // ==========================
        // GLOBAL VARIABLES
        // ==========================
        let balance = parseFloat(localStorage.getItem("balance")) || 0.50;
        let roundNumber = parseInt(localStorage.getItem("roundNumber")) || 0;
        let gameOver = localStorage.getItem("gameOver") === "true";
        let currentBias = null;
        const WEB_APP_URL = "https://script.google.com/macros/s/YOUR_WEB_APP_URL_HERE/exec"; // <-- Replace with your Apps Script URL
        const userid = localStorage.getItem("userid") || ("user_" + Math.floor(Math.random()*1000000));
        localStorage.setItem("userid", userid);

        document.getElementById("balance").innerText = balance.toFixed(2);

        // ==========================
        // CONDITION ASSIGNMENT
        // ==========================
        let condition = localStorage.getItem("condition");
        if (!condition) {
            condition = Math.random() < 0.5 ? "control" : "treatment";
            localStorage.setItem("condition", condition);
        }
        document.getElementById("conditionDisplay").innerText = condition;

        // Show treatment buttons only if treatment
        if (condition === "treatment") {
            document.getElementById("treatmentButtons").style.display = "block";
        }

        // ==========================
        // QUICK BET FUNCTIONS (Treatment)
        // ==========================
        function quickBet5() {
            document.getElementById("bet").value = 5;
        }

        function quickBetKelly() {
            if (currentBias === null) {
                alert("Bias for this round is not yet set.");
                return;
            }

            // Kelly fraction: f* = 2p - 1
            let f = 2 * currentBias - 1;
            if (f < 0) f = 0;

            let betCents = Math.round(f * balance * 100);
            if (betCents < 1) betCents = 1;
            if (betCents > balance * 100) betCents = Math.floor(balance * 100);

            document.getElementById("bet").value = betCents;
        }

        // ==========================
        // GAME LOGIC
        // ==========================
        function getRandomBias() {
            const biases = [0.55, 0.60, 0.70];
            return biases[Math.floor(Math.random() * biases.length)];
        }

        function flipCoin(bias) {
            return Math.random() < bias ? "Heads" : "Tails";
        }

        function startRound() {
            if (gameOver) return;
            currentBias = getRandomBias();
            document.getElementById("biasDisplay").innerText = currentBias.toFixed(2);
        }

        function play(choice) {
            if (gameOver) return;

            const betInput = document.getElementById("bet");
            let bet = parseInt(betInput.value);
            if (isNaN(bet) || bet <= 0) {
                alert("Invalid bet amount.");
                return;
            }
            bet = bet / 100; // dollars

            if (bet > balance) {
                alert("Invalid bet amount. Cannot bet more than your current balance.");
                return;
            }

            const startBalance = balance;
            const result = flipCoin(currentBias);
            const outcome = (choice === result) ? "win" : "loss";

            balance = (outcome === "win") ? balance + bet : balance - bet;
            balance = Math.round(balance * 100) / 100;
            const endBalance = balance;

            document.getElementById("balance").innerText = balance.toFixed(2);
            betInput.value = "";

            roundNumber++;
            localStorage.setItem("balance", balance);
            localStorage.setItem("roundNumber", roundNumber);

            const timestamp = new Date().toISOString();

            // Send data to backend
            sendData({
                userid: userid,
                condition: condition,
                round_number: roundNumber,
                timestamp: timestamp,
                bet_amount: bet,
                choice: choice,
                outcome: outcome,
                probability_heads: currentBias,
                endowment_start: startBalance,
                endowment_end: endBalance
            });

            // Update history
            const entry = document.createElement("div");
            entry.innerHTML = "Round " + roundNumber +
                " | " + outcome +
                " | Balance: $" + endBalance.toFixed(2) +
                " | Prob(Heads): " + currentBias.toFixed(2);
            document.getElementById("history").prepend(entry);

            // Check stopping rules
            if (balance <= 0) { endGame("The game is over as your balance reached $0."); return; }
            if (balance >= 7.5) { endGame("The game is over as your balance reached or exceeded $7.50."); return; }

            // Start next round
            startRound();
        }

        function endGame(msg) {
            gameOver = true;
            localStorage.setItem("gameOver", true);
            alert(msg);
        }

        // ==========================
        // BACKEND DATA LOGGING
        // ==========================
        function sendData(data) {
            fetch(WEB_APP_URL, {
                method: "POST",
                body: JSON.stringify(data),
                headers: { "Content-Type": "application/json" }
            })
            .then(response => console.log("Data sent"))
            .catch(err => console.error("Error sending data:", err));
        }

        // ==========================
        // INITIALIZE FIRST ROUND
        // ==========================
        startRound();
    </script>
</body>
</html>
